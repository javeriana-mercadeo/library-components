<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
  integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
  crossorigin="anonymous"
/>
<script src="https://www.javeriana.edu.co/recursosdb/1372208/10609114/vueprod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
  body {
    background-color: #f5f5f5;
  }

  .header-section {
    background: white;
    color: #4a90e2;
  }

  .form-container {
    max-width: 520px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  }

  .form-control {
    background-image: none !important;
  }

  .form-control:focus {
    border-color: #4a90e2;
    box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.25);
  }

  .form-control,
  .form-control:focus {
    height: calc(1.5em + 0.75rem + 2px);
    padding: 0.375rem 0.75rem;
    font-size: 1rem;
    line-height: 1.5;
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .btn-primary {
    background: linear-gradient(135deg, #4a90e2, #357abd);
    border: none;
    border-radius: 25px;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #357abd, #2868a8);
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .btn-primary:disabled {
    background: #6c757d !important;
    border-color: #6c757d !important;
    transform: none !important;
    box-shadow: none !important;
    cursor: not-allowed !important;
    opacity: 0.65;
  }

  .btn-primary:not(:disabled):not(.disabled) {
    background: linear-gradient(135deg, #4a90e2, #357abd) !important;
    border-color: #4a90e2 !important;
    cursor: pointer;
  }

  .form-check-input {
    accent-color: #4a90e2;
    margin-top: 0.125rem;
    width: 1rem;
    height: 1rem;
    cursor: pointer;
  }

  .form-check-inline {
    margin-right: 2rem;
    margin-bottom: 0;
    padding-left: 0;
  }

  .form-check-label {
    margin-bottom: 0;
    margin-left: 0.375rem;
    font-size: 0.9rem;
    line-height: 1.25rem;
    cursor: pointer;
  }

  .invalid-feedback {
    display: block;
    color: #dc3545;
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .is-invalid {
    border-color: #dc3545;
  }

  .is-invalid:focus {
    border-color: #dc3545;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
  }
</style>

<div style="background-color: #f5f5f5; padding: 0; margin: 0">
  <div id="app">
    <div class="form-container bg-white mx-auto rounded shadow">
      <div class="text-center p-3">
        <h2 class="mt-2">Expojaveriana Pregrados</h2>
        <p class="mb-0">Regístrate para tener acceso al evento</p>
      </div>

      <form
        id="form_SF"
        ref="form_SF"
        v-on:submit.prevent="validateForm"
        action="https://webto.salesforce.com/servlet/servlet.WebToLead?encoding=UTF-8"
        method="POST"
        novalidate=""
        aria-label="Formulario de contacto"
        class="needs-validation p-4"
      >
        <input type="hidden" name="oid" value="00Df4000003l8Bf" />
        <input
          type="hidden"
          name="retURL"
          id="retURL"
          value="https://www.javeriana.edu.co/expojaveriana/thankyoupage-expojaveriana-pregrados"
        />
        <input type="hidden" name="debug" value="0" />
        <input type="hidden" name="debugEmail" value="" />

        <!-- Campos hidden para nombre y fecha del evento -->
        <input type="hidden" name="00NJw000006f1BF" :value="data.nevento" />
        <input type="hidden" name="00NJw000006f1BE" :value="data.fevento" />

        <div class="row">
          <div class="col-md-6 mb-3">
            <input
              placeholder="*Nombre(s)"
              id="first_name"
              v-model="data.first_name"
              maxlength="40"
              v-on:change="deleteInvalid('first_name')"
              name="first_name"
              type="text"
              class="form-control"
              :class="{ 'is-invalid': errors.first_name }"
              required=""
            />
            <div class="invalid-feedback" v-show="errors.first_name">Completa este campo</div>
          </div>

          <div class="col-md-6 mb-3">
            <input
              placeholder="*Apellidos"
              id="last_name"
              v-model="data.last_name"
              v-on:change="deleteInvalid('last_name')"
              maxlength="80"
              name="last_name"
              type="text"
              required=""
              class="form-control"
              :class="{ 'is-invalid': errors.last_name }"
            />
            <div class="invalid-feedback" v-show="errors.last_name">Completa este campo</div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <select
              id="00N5G00000WmhsT"
              v-model="data.tipo_doc"
              v-on:change="deleteInvalid('tipo_doc')"
              name="00N5G00000WmhsT"
              required=""
              class="form-control"
              :class="{ 'is-invalid': errors.tipo_doc }"
            >
              <option value="">*Tipo de documento</option>
              <option value="CC">Cédula Ciudadanía</option>
              <option value="CE">Cédula Extranjería</option>
              <option value="PA">Pasaporte</option>
              <option value="TI">Tarjeta Identidad</option>
            </select>
            <div class="invalid-feedback" v-show="errors.tipo_doc">Selecciona</div>
          </div>

          <div class="col-md-6 mb-3">
            <input
              placeholder="*Número de documento"
              v-on:change="deleteInvalid('numero_doc')"
              v-model="data.numero_doc"
              id="00N5G00000WmhsR"
              maxlength="255"
              name="00N5G00000WmhsR"
              type="text"
              required=""
              class="form-control"
              :class="{ 'is-invalid': errors.numero_doc }"
            />
            <div class="invalid-feedback" v-show="errors.numero_doc">Completa este campo</div>
          </div>
        </div>
        <div class="mb-3">
          <input
            placeholder="*Email"
            id="email"
            v-model="data.email"
            v-on:change="deleteInvalid('email')"
            maxlength="80"
            name="email"
            type="email"
            required=""
            class="form-control"
            :class="{ 'is-invalid': errors.email }"
          />
          <div class="invalid-feedback" v-show="errors.email">Ingresa un correo válido</div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <select
              id="00NJw000002mzb7"
              name="00NJw000002mzb7"
              class="form-control"
              v-model="data.prefijoCel"
              v-on:change="deleteInvalid('prefijoCel')"
              :class="{ 'is-invalid': errors.prefijoCel }"
              required=""
            >
              <option
                v-for="pais in prefijoCel"
                :value="pais.phoneCode"
                v-bind:style="{ backgroundColor: pais.phoneName === 'Colombia' ? 'aliceBlue' : '', color: pais.phoneName === 'Colombia' ? '#000000' : '', fontWeight: pais.phoneName === 'Colombia' ? '900' : '' }"
                v-bind:selected="pais.phoneName === 'Colombia'"
              >
                (+{{ pais.phoneCode }}) {{ pais.phoneName }}
              </option>
            </select>
            <div class="invalid-feedback" v-show="errors.prefijoCel">*Seleccione</div>
          </div>

          <div class="col-md-6 mb-3">
            <input
              placeholder="*Teléfono celular"
              id="mobile"
              v-model="data.mobile"
              v-on:change="deleteInvalid('mobile')"
              name="mobile"
              type="text"
              minlength="8"
              maxlength="15"
              required=""
              class="form-control"
              :class="{ 'is-invalid': errors.mobile }"
            />
            <div class="invalid-feedback" v-show="errors.mobile">
              *Campo obligatorio (entre 8 y 10 caracteres)
            </div>
          </div>
        </div>

        <div class="mb-3">
          <select
            v-model="data.pais"
            v-on:change="deleteInvalid('pais')"
            class="form-control"
            id="00N5G00000WmhvJ"
            name="00N5G00000WmhvJ"
            required=""
            :class="{ 'is-invalid': errors.pais }"
          >
            <option value="">*País de residencia</option>
            <option
              v-for="(item, index) in ubicaciones"
              v-bind:value="index"
              v-bind:style="(index=='COL') ? 'font-weight: 700;' : '' "
            >
              {{ item.nombre }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.pais">Selecciona</div>
        </div>

        <div class="mb-3" v-if="data.pais=='COL'">
          <select
            v-model="data.departamento"
            v-on:change="deleteInvalid('departamento')"
            id="00N5G00000WmhvX"
            name="00N5G00000WmhvX"
            class="form-control"
            :class="{ 'is-invalid': errors.departamento }"
          >
            <option value="">*Selecciona el departamento</option>
            <option
              v-for="(item, index) in ubicaciones[data.pais]?.departamentos || []"
              v-bind:value="item.codigo"
            >
              {{ item.nombre }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.departamento">Selecciona</div>
        </div>

        <div class="mb-3" v-if="data.pais=='COL' &amp;&amp; data.departamento!=''">
          <select
            v-model="data.ciudad"
            v-on:change="deleteInvalid('ciudad')"
            id="00N5G00000WmhvO"
            name="00N5G00000WmhvO"
            class="form-control"
            :class="{ 'is-invalid': errors.ciudad }"
            v-bind:required="data.pais=='COL'"
          >
            <option value="">*Selecciona la Ciudad</option>
            <option
              v-for="(item, index) in getCiudades(data.departamento)"
              v-bind:value="item.codigo"
            >
              {{ item.nombre }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.ciudad">Selecciona</div>
        </div>

        <div class="mb-3">
          <select
            v-model="data.tipo_asistente"
            v-on:change="deleteInvalid('tipo_asistente')"
            name="00NJw000001J3g6"
            id="00NJw000001J3g6"
            required=""
            class="form-control"
            :class="{ 'is-invalid': errors.tipo_asistente }"
          >
            <option value="">*Tipo de asistente</option>
            <option value="Aspirante">Aspirante</option>
            <option value="Padre de familia y/o acudiente">Padre de familia y/o acudiente</option>
            <option value="Docente y/o psicoorientador">Docente y/o psicoorientador</option>
            <option value="Visitante PUJ">Visitante PUJ</option>
            <!-- <option value="Administrativo PUJ">Administrativo PUJ</option> -->
          </select>
          <div class="invalid-feedback" v-show="errors.tipo_asistente">Selecciona</div>
        </div>

        <input
          type="hidden"
          name="00N5G00000WmhvV"
          value="NOAP"
          v-if="data.tipo_asistente=='Padre de familia y/o acudiente' || data.tipo_asistente=='Visitante PUJ' || data.tipo_asistente=='Administrativo PUJ' || data.tipo_asistente=='Docente y/o psicoorientador'"
        />

        <!-- Nivel académico para aspirantes -->
        <div class="mb-3" v-if="data.tipo_asistente=='Aspirante'">
          <select
            v-model="data.nivelacademico"
            v-on:change="deleteInvalid('nivelacademico')"
            name="nivelacademico"
            id="nivelacademico"
            class="form-control"
            :class="{ 'is-invalid': errors.nivelacademico }"
          >
            <option value="">*Nivel académico</option>
            <option value="PREG">Pregrado</option>
            <!--               <option value="GRAD">Posgrado</option> -->
            <option value="ETDH">Técnico</option>
            <!-- <option value="ECLE">Eclesiástico</option> -->
          </select>
          <div class="invalid-feedback" v-show="errors.nivelacademico">Selecciona</div>
        </div>

        <!-- Facultad para aspirantes -->
        <div
          class="mb-3"
          v-if="data.nivelacademico!='' &amp;&amp; data.tipo_asistente=='Aspirante'"
        >
          <select
            v-model="data.facultad"
            v-on:change="deleteInvalid('facultad')"
            name="Facultad"
            id="Facultad"
            class="form-control"
            :class="{ 'is-invalid': errors.facultad }"
          >
            <option value="">*Selecciona la facultad</option>
            <option
              v-for="item in programas[data.nivelacademico] || []"
              v-bind:value="item.FacultadCodigo"
            >
              {{ item.FacultadCodigo }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.facultad">Selecciona</div>
        </div>

        <!-- Programa para aspirantes -->
        <div class="mb-3" v-if="data.facultad!=''">
          <select
            v-model="data.programa"
            v-on:change="deleteInvalid('programa')"
            name="00N5G00000WmhvV"
            id="00N5G00000WmhvV"
            class="form-control"
            :class="{ 'is-invalid': errors.programa }"
          >
            <option value="">*Selecciona el programa</option>
            <option value="NOAP" style="display: none">NOAP</option>
            <option
              v-for="prog in programas[data.nivelacademico][data.facultad]?.Programas || []"
              v-bind:value="prog.Codigo"
            >
              {{ prog.Nombre }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.programa">Selecciona</div>
        </div>

        <!-- Periodo esperado para aspirantes -->
        <div class="mb-3" v-if="data.facultad!='' &amp;&amp; data.tipo_asistente=='Aspirante'">
          <select
            v-model="data.periodo_esperado"
            v-on:change="deleteInvalid('periodo_esperado')"
            name="00N5G00000WmhvI"
            id="00N5G00000WmhvI"
            class="form-control"
            :class="{ 'is-invalid': errors.periodo_esperado }"
          >
            <option value="">*Periodo esperado de Ingreso</option>
            <option v-for="(index, item) in periodoSel" v-bind:value="index" :key="index">
              {{ item }}
            </option>
          </select>
          <div class="invalid-feedback" v-show="errors.periodo_esperado">Selecciona</div>
        </div>
        <br />

        <!-- Sección de colegios/universidades -->
        <div
          class="mb-3"
          v-if="data.tipo_asistente!='' &amp;&amp; (data.tipo_asistente=='Aspirante' || data.tipo_asistente=='Docente y/o psicoorientador') &amp;&amp; (data.nivelacademico =='PREG' || data.nivelacademico =='GRAD' || data.nivelacademico =='ETDH')"
        >
          <h5
            v-if="(data.nivelacademico =='PREG' || data.nivelacademico == 'ETDH') &amp;&amp; data.nivelacademico !='ECLE' &amp;&amp; data.tipo_asistente == 'Aspirante'"
            style="color: #4a90e2; margin-bottom: 1rem"
          >
            ¿En qué colegio estudias o de cuál colegio te graduaste?
          </h5>
          <h5
            v-if="(data.nivelacademico =='PREG' || data.nivelacademico == 'ETDH') &amp;&amp; data.nivelacademico !='ECLE' &amp;&amp; data.tipo_asistente == 'Docente y/o psicoorientador'"
            style="color: #4a90e2; margin-bottom: 1rem"
          >
            ¿En qué institución educativa trabajas o has trabajado?
          </h5>
          <h5
            v-if="(data.nivelacademico =='GRAD') &amp;&amp; data.nivelacademico !='ECLE'"
            style="color: #4a90e2; margin-bottom: 1rem"
          >
            ¿En qué Universidad estudias o de cuál Universidad te graduaste?
          </h5>
          <p class="mb-3" style="color: #666; font-size: 0.9rem">
            Puedes filtrar por ciudad/departamento o escribir una palabra clave
          </p>

          <div class="row">
            <div class="col-6 mb-3">
              <select v-model="selectedDepartment" @change="filterCities" class="form-control">
                <option value="">Filtrar por Departamento</option>
                <option v-for="dep in departments" :key="dep.codigo" :value="dep.codigo">
                  {{ dep.nombre }}
                </option>
              </select>
            </div>

            <div class="col-6 mb-3">
              <select v-model="selectedCity" @change="filterColegios" class="form-control">
                <option value="">Filtrar por Ciudad</option>
                <option v-for="city in cities" :key="city.codigo" :value="city.nombre">
                  {{ city.nombre }}
                </option>
              </select>
            </div>
          </div>

          <div class="mb-3">
            <input
              type="text"
              v-model="searchTerm"
              @input="filterColegios"
              placeholder="Filtrar por nombre o palabra clave"
              class="form-control"
            />
          </div>

          <ul
            v-show="(filteredColegios.length &gt; 0 &amp;&amp; (selectedCity || selectedDepartment || searchTerm)) &amp;&amp; !colegioSeleccionado"
            class="list-group"
            style="max-height: 200px; overflow-y: auto; margin-bottom: 15px"
          >
            <li
              v-for="(colegio, index) in filteredColegios.slice(0, 100)"
              :key="colegio.ID"
              @click.prevent="selectColegio(colegio.PUJ_EXTERNALORGID__C, colegio.NAME)"
              class="list-group-item list-group-item-action"
              style="cursor: pointer; background-color: #f8f9fa; user-select: none"
              :title="'Click to select: ' + colegio.NAME"
            >
              {{ colegio.NAME }}
            </li>
          </ul>

          <input
            v-if="data.nivelacademico =='PREG'"
            type="hidden"
            id="00NJw0000041omr"
            name="00NJw0000041omr"
            v-model="data.colegio"
          />
          <input
            v-if="data.nivelacademico !='PREG'"
            type="hidden"
            id="00NJw000006f1BG"
            name="00NJw000006f1BG"
            v-model="data.colegio"
          />
          <div class="invalid-feedback" v-show="errors.colegio" style="display: block">
            Selecciona
          </div>
        </div>

        <!-- día de asistencia -->
        <div class="mb-3" v-if="data.tipo_asistente!=''">
          <h5 style="color: #4a90e2; margin-bottom: 1rem">¿Qué día Asistirás?</h5>
          <select
            v-model="data.dia"
            v-on:change="deleteInvalid('dia')"
            class="form-control"
            id="00NJw000004iuIj"
            name="00NJw000004iuIj"
            :class="{ 'is-invalid': errors.dia }"
          >
            <option value="" selected>*Día de asistencia</option>
            <option value="24 de septiembre">24 de septiembre</option>
            <option value="25 de septiembre">25 de septiembre</option>
          </select>
          <div class="invalid-feedback" v-show="errors.dia">Selecciona</div>
        </div>

        <!-- para ocultar-->
        <div style="display: none">
          <div class="form-row">
            Origen de la Solicitud:<select
              id="00NJw000001J3Hl"
              name="00NJw000001J3Hl"
              v-model="data.origen_sol"
              title="Origen de la Solicitud"
            >
              <option selected="" value="Web to Lead">Web to Lead</option>
            </select>

            Fuente autorización datos personales:<select
              id="00N5G00000WmhvT"
              name="00N5G00000WmhvT"
              v-model="data.fuenteAutoriza"
              title="Fuente autorización datos personales"
            >
              <option value="Landing Eventos">Landing Eventos</option>
            </select>
            <label for="lead_source">Origen del candidato</label>
            <select id="lead_source" v-model="data.lead" name="lead_source">
              <option value="Landing Pages">Landing Pages</option>
            </select>
            <label for="company">Compañía</label
            ><input
              id="company"
              v-model="data.company"
              maxlength="40"
              name="company"
              size="20"
              type="text"
              value="NA"
            />
          </div>

          <!--UTMS-->
          <div class="form-row">
            Fuente:<input
              id="00N5G00000WmhvW"
              v-model="data.fuente"
              name="00N5G00000WmhvW"
              title="Fuente"
              type="text"
            />
            Subfuente:<input
              id="00N5G00000WmhvZ"
              v-model="data.subfuente"
              name="00N5G00000WmhvZ"
              title="Subfuente"
              type="text"
            />
            Medio
            <input
              id="00NJw000001J3g8"
              v-model="data.medio"
              name="00NJw000001J3g8"
              title="Medio"
              type="text"
            />
            Articulo:<input
              id="00NJw000006f1BB"
              v-model="data.articulo"
              maxlength="255"
              title="Articulo"
              name="00NJw000006f1BB"
              type="text"
            />
            Campaña:<input
              id="00N5G00000Wmi8x"
              v-model="data.campana"
              maxlength="255"
              name="00N5G00000Wmi8x"
              type="text"
            />
          </div>
        </div>

        <div class="mt-4 mb-3">
          <p class="mb-2">
            ¿Autoriza el tratamiento de sus datos personales de acuerdo con la
            <a
              href="https://www.javeriana.edu.co/informacion/politica-y-tratamiento-de-datos-personales"
              target="_blank"
              class="text-primary"
              >autorización de privacidad</a
            >?
          </p>
          <div class="form-check form-check-inline">
            <input
              v-on:change="validateAutoriza()"
              class="form-check-input"
              type="radio"
              v-model="data.autoriza"
              id="autoriza_si"
              name="00N5G00000WmhvF"
              value="1"
            />
            <label class="form-check-label" for="autoriza_si">Sí</label>
          </div>
          <div class="form-check form-check-inline">
            <input
              v-on:change="validateAutoriza()"
              class="form-check-input"
              type="radio"
              v-model="data.autoriza"
              name="00N5G00000WmhvF"
              id="autoriza_no"
              value="0"
            />
            <label class="form-check-label" for="autoriza_no">No</label>
          </div>
          <div class="text-danger small mt-2" v-show="errors.autoriza">
            La Pontificia Universidad Javeriana requiere de su autorización para el tratamiento de
            sus datos personales para continuar con el presente proceso
          </div>
        </div>

        <button
          id="boton_enviar2"
          class="btn btn-primary btn-lg btn-block"
          type="submit"
          v-bind:disabled="formInValid || isSubmitting"
        >
          Inscríbete
        </button>
        <div
          id="successMsg"
          class="wpcf7-response-output"
          style="
            border: 2px solid green;
            background-color: lightgrey;
            padding: 10px;
            border-radius: 5px;
            display: none;
          "
        >
          Gracias por tu mensaje. Ha sido enviado.
        </div>
      </form>
    </div>
  </div>

  <!--http://127.0.0.1:3000/Form.html?utm_source=Comercial&utm_subsource=Invitación&utm_medium=Correo&utm_campaign=Liferay-->
  <!-- Programa por confirmar: NOAP -->
</div>

<script>
  const { createApp } = Vue;

  const app = createApp({
    data() {
      return {
        prefijoCel: [],
        programas: [],
        periodos: [],
        ubicaciones: [],
        periodoSel: [],
        universidads: [],
        colegios: [],
        filteredColegios: [],
        colegioSeleccionado: false,
        selectedDepartment: "",
        departments: [],
        searchTerm: "", // Para el término de búsqueda
        selectedCity: "", // Para la ciudad seleccionada
        filteredUniversidades: [], // Universidades filtrados
        cities: [], // Lista de ciudades
        formInValid: true,
        isSubmitting: false,
        data: {
          nevento: "Expojaveriana Pregrado",
          fevento: "24/09/2025 12:00 PM",
          first_name: "",
          last_name: "",
          tipo_doc: "",
          numero_doc: "",
          email: "",
          mobile: "",
          prefijoCel: "57",
          pais: "",
          departamento: "",
          ciudad: "",
          tipo_asistente: "",
          nivelacademico: "",
          facultad: "",
          programa: "NOAP",
          universidad: "",
          periodo_esperado: "",
          colegio: "",
          dia: "",
          origen_sol: "Web to Lead",
          fuenteAutoriza: "Landing Eventos",
          lead: "Landing Pages",
          company: "NA",
          fuente: "Javeriana",
          subfuente: "Organico",
          medio: "Landing",
          articulo: "Articulo",
          campana: "MERCA_ExpoPreVirtual2025",
          autoriza: "",
          programNoap: "",
        },
        errors: {
          nevento: false,
          fevento: false,
          first_name: false,
          last_name: false,
          tipo_doc: false,
          numero_doc: false,
          email: false,
          mobile: false,
          prefijoCel: false,
          pais: false,
          departamento: false,
          ciudad: false,
          tipo_asistente: false,
          nivelacademico: false,
          facultad: false,
          programa: false,
          universidad: false,
          periodo_esperado: false,
          colegio: false,
          dia: false,
          origen_sol: false,
          fuenteAutoriza: false,
          lead: false,
          company: false,
          fuente: false,
          subfuente: false,
          medio: false,
          articulo: false,
          campana: false,
          autoriza: false,
        },
      };
    },
    watch: {
      "data.mobile": function (newMobile, oldMobile) {
        this.data.mobile = this.limpiarNumeros(newMobile);
      },
      "data.email": function (newEmail, oldEmail) {
        const regex =
          /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if (regex.test(newEmail) === false) {
          this.errors.email = true;
        } else {
          this.errors.email = false;
        }
      },
      "data.nivelacademico": function (newPerido, oldPeriodo) {
        this.periodoSel = this.periodos[newPerido];
        if (newPerido != oldPeriodo) {
          this.data.programa = "";
          this.data.facultad = "";
          this.data.periodo_esperado = "";
          this.data.colegio = "";
          this.loadColegios(newPerido);
        }
        this.updateFormValid();
      },
      "data.facultad": function (newFacultad, oldFacultad) {
        if (newFacultad != oldFacultad) {
          this.data.programa = "";
        }
      },
      "data.tipo_asistente": function (newAsis, oldAsis) {
        if (newAsis != oldAsis) {
          this.data.nivelacademico = "";
          this.data.facultad = "";
          this.data.colegio = "";
          this.searchTerm = "";
          this.selectedDepartment = "";
          this.selectedCity = "";
          this.data.dia = "";
        }
        if (newAsis == "Aspirante") {
          this.data.nivelacademico = "";
        } else if (newAsis == "Docente y/o psicoorientador") {
          this.data.nivelacademico = "PREG"; // Asignar PREG por defecto para mostrar colegios
          this.data.programa = "NOAP";
        } else {
          this.data.programa = "NOAP";
        }
        // Actualizar validación cuando cambia el tipo de asistente
        this.updateFormValid();
      },
      // Watcher general para campos importantes
      "data.first_name": function () {
        this.updateFormValid();
      },
      "data.last_name": function () {
        this.updateFormValid();
      },
      "data.email": function () {
        this.updateFormValid();
      },
      "data.mobile": function () {
        this.updateFormValid();
      },
      "data.tipo_doc": function () {
        this.updateFormValid();
      },
      "data.numero_doc": function () {
        this.updateFormValid();
      },
      "data.pais": function () {
        this.updateFormValid();
      },
      "data.prefijoCel": function () {
        this.updateFormValid();
      },
      "data.facultad": function () {
        this.updateFormValid();
      },
      "data.programa": function () {
        this.updateFormValid();
      },
      "data.departamento": function () {
        this.updateFormValid();
      },
      "data.ciudad": function () {
        this.updateFormValid();
      },
      "data.periodo_esperado": function () {
        this.updateFormValid();
      },
      "data.colegio": function () {
        this.updateFormValid();
      },
      "data.dia": function () {
        this.updateFormValid();
      },
      selectedDepartment: function (newDepartment) {
        this.filterCities();
      },
      selectedCity: function (newCity) {
        this.filterColegios();
      },
      searchTerm: function (newTerm) {
        this.filterColegios();
      },
    },
    mounted() {
      // Recien carga el sitio se cargan los datos
      this.limpiarDatos();
      this.getUbicaciones();
      this.getPeriodos();
      this.getProgramas();
      this.getParametersGet();
      this.getPrefijoCel();
      this.loadColegios();

      // Asegurar que el estado del formulario se actualice inicialmente
      this.$nextTick(() => {
        this.updateFormValid();
      });
    },
    methods: {
      /**
       * Funcion para limpiar la variable de los datos
       **/
      limpiarDatos() {
        this.data = {
          nevento: "Expojaveriana Pregrado",
          fevento: "24/09/2025 12:00 PM",
          first_name: "",
          last_name: "",
          tipo_doc: "",
          numero_doc: "",
          email: "",
          mobile: "",
          prefijoCel: "57",
          pais: "",
          departamento: "",
          ciudad: "",
          tipo_asistente: "",
          nivelacademico: "",
          facultad: "",
          programa: "NOAP",
          universidad: "",
          periodo_esperado: "",
          colegio: "",
          dia: "",
          origen_sol: "Web to Lead",
          fuenteAutoriza: "Landing Eventos",
          lead: "Landing Pages",
          company: "NA",
          fuente: "Javeriana",
          subfuente: "Organico",
          medio: "Landing",
          articulo: "",
          campana: "MERCA_ExpoPreVirtual2025",
          autoriza: "",
          programNoap: "",
        };
      },
      /**
       * Funcion para obtener los valores de los parametros que vienen por GET
       **/
      getParametersGet() {
        let urlParams = new URLSearchParams(window.location.search);
        this.data.fuente = urlParams.has("utm_source")
          ? urlParams.get("utm_source")
          : this.data.fuente;
        this.data.subfuente = urlParams.has("utm_subsource")
          ? urlParams.get("utm_subsource")
          : this.data.subfuente;
        this.data.medio = urlParams.has("utm_medium")
          ? urlParams.get("utm_medium")
          : this.data.medio;
        this.data.campana = urlParams.has("utm_campaign")
          ? urlParams.get("utm_campaign")
          : this.data.campana;
        this.data.articulo = urlParams.has("utm_article")
          ? urlParams.get("utm_article")
          : this.data.articulo;
        this.data.fevento = urlParams.has("fevento") ? urlParams.get("fevento") : this.data.fevento;
        this.data.nevento = urlParams.has("nevento") ? urlParams.get("nevento") : this.data.nevento;
      },
      /**
       * Funcion para cargar los programas
       **/
      getProgramas() {
        axios
          //.get("/Json/programas.json")
          .get("https://www.javeriana.edu.co/recursosdb/1372208/10609114/programas.json")
          .then((response) => {
            this.programas = response.data;
          })
          .catch(function (error) {
            console.log(error);
          });
      },
      /**
       * Funcion para cargar los periodos
       **/
      getPeriodos() {
        axios
          //.get("/Json/periodos.json")
          .get("https://www.javeriana.edu.co/recursosdb/1372208/10609114/periodos.json")
          .then((response) => {
            this.periodos = response.data;
          })
          .catch(function (error) {
            console.log("Error loading periodos:", error);
          });
      },
      /**
       * Funcion para cargar las ubicaciones
       **/
      getUbicaciones() {
        axios
          //.get("/Json/ubicaciones.json")
          .get("https://www.javeriana.edu.co/recursosdb/1372208/10609114/ubicaciones.json")
          .then((response) => {
            this.ubicaciones = response.data;

            // Obtener la lista de departamentos
            this.departments = this.ubicaciones.COL.departamentos
              .map((departamento) => ({
                nombre: departamento.nombre,
                codigo: departamento.codigo,
              }))
              .sort((a, b) => a.nombre.localeCompare(b.nombre));

            // Trigger Vue reactivity update after departments are loaded
            this.$nextTick(() => {
              console.log(
                "Vue nextTick after departments loaded - departments:",
                this.departments.length
              );
            });
          })
          .catch(function (error) {
            console.log("Error loading ubicaciones:", error);
          });
      },
      /**
       * Funcion para obtener las ciudades del departamento seleccionado
       **/
      getCiudades(departamento) {
        let departamentoSel = this.ubicaciones["COL"].departamentos.filter((res) => {
          return res.codigo == departamento;
        });
        return departamentoSel[0].ciudades;
      },
      getPrefijoCel() {
        axios
          //.get("/Json/codigos_pais.json")
          .get("https://www.javeriana.edu.co/recursosdb/1372208/10609114/codigos_pais.json")
          .then((response) => {
            // Filtrar los datos para obtener solo los códigos de país y sus prefijos
            this.prefijoCel = response.data.map((pais) => {
              return {
                iso2: pais.iso2,
                phoneCode: pais.phoneCode,
                phoneName: pais.nameES,
              };
            });
          });
      },

      /*colegios*/
      loadColegios(nivelAcademico) {
        let url;
        if (nivelAcademico === "GRAD") {
          //url = "/JSON/universidades.json";
          url = "https://www.javeriana.edu.co/recursosdb/1372208/10609114/universidades.json";
        } else {
          //url = "/JSON/Colegios PRD.json";
          url = "https://www.javeriana.edu.co/recursosdb/1372208/10609114/Colegios+PRD.json";
        }
        axios
          .get(url)
          .then((response) => {
            this.colegios = response.data.cuentasInstitucionales;
            this.filterColegios();
          })
          .catch((error) => {
            console.error("Error al cargar los colegios:", error);
          });
      },
      selectColegio(externalId, nombreColegio) {
        this.data.colegio = externalId; // Asigna el valor del ID del colegio seleccionado
        this.searchTerm = nombreColegio; // Actualiza el campo de búsqueda con el nombre del colegio seleccionado
        this.colegioSeleccionado = true; // Marca que se ha seleccionado un colegio
        this.errors.colegio = false; // Limpia el error si es necesario

        // Trigger form validation update
        this.updateFormValid();
      },

      // Método para filtrar ciudades según el departamento seleccionado
      filterCities() {
        try {
          // Encuentra el departamento seleccionado
          const selectedDep = this.ubicaciones.COL.departamentos.find(
            (dep) => dep.codigo === this.selectedDepartment
          );

          if (selectedDep) {
            // Filtra las ciudades que tienen colegios
            const ciudadesConColegios = new Set(
              this.colegios.map((colegio) => colegio.SHIPPINGCITY)
            );

            // Solo muestra ciudades que pertenecen al departamento y tienen colegios
            this.cities = selectedDep.ciudades
              .filter((ciudad) => ciudadesConColegios.has(ciudad.nombre))
              .sort((a, b) => a.nombre.localeCompare(b.nombre)); // Ordena las ciudades alfabéticamente

            // Resetea la ciudad seleccionada cuando cambia el departamento
            this.selectedCity = "";
          } else {
            this.cities = []; // Si no hay departamento seleccionado, resetea las ciudades
            this.selectedCity = "";
          }

          // Resetear el colegio seleccionado y limpiar la lista de colegios filtrados
          this.data.colegio = "";
          this.filteredColegios = [];
          this.searchTerm = ""; // Limpia el campo de búsqueda
          this.filterColegios(); // Actualiza la lista de colegios
        } catch (error) {
          console.error("Error in filterCities:", error);
        }
      },

      // Método para filtrar colegios según la ciudad seleccionada o el término de búsqueda
      filterColegios() {
        // Si el campo de búsqueda está vacío, resetea el colegio seleccionado
        if (!this.searchTerm) {
          this.data.colegio = "";
          this.colegioSeleccionado = false; // Indica que no hay colegio seleccionado
        }

        // Log sample college structure for debugging
        if (this.colegios.length > 0) {
        }

        // Filtra los colegios según departamento, ciudad y el término de búsqueda
        this.filteredColegios = this.colegios
          .filter((colegio) => {
            // Si hay ciudad seleccionada, filtrar por ciudad (ignora departamento)
            if (this.selectedCity) {
              const matchesCity = colegio.SHIPPINGCITY === this.selectedCity;
              const matchesSearch = colegio.NAME.toLowerCase().includes(
                this.searchTerm.toLowerCase()
              );

              // Log para debugging de ciudad (solo los primeros 3)
              if (this.filteredColegios.length < 3) {
                console.log("City filter check:", {
                  collegeName: colegio.NAME,
                  collegeCity: colegio.SHIPPINGCITY,
                  selectedCity: this.selectedCity,
                  matchesCity,
                  matchesSearch,
                  passes: matchesCity && matchesSearch,
                });
              }

              return matchesCity && matchesSearch;
            }

            // Si hay departamento pero no ciudad, filtrar por departamento
            if (this.selectedDepartment) {
              const matchesDepartment = colegio.SHIPPINGSTATE === this.selectedDepartment;
              const matchesSearch = colegio.NAME.toLowerCase().includes(
                this.searchTerm.toLowerCase()
              );
              return matchesDepartment && matchesSearch;
            }

            // Si solo hay término de búsqueda, buscar en todos los colegios
            const matchesSearch = colegio.NAME.toLowerCase().includes(
              this.searchTerm.toLowerCase()
            );
            return matchesSearch;
          })
          .sort((a, b) => a.NAME.localeCompare(b.NAME)); // Ordena los colegios alfabéticamente

        if (this.filteredColegios.length === 0) {
          this.data.colegio = "";
        }
      },

      /**
       * Funcion para validar si esta el campo de aceptar terminos
       **/
      validateAutoriza() {
        if (this.data.autoriza == "1") {
          this.errors.autoriza = false;
        } else if (this.data.autoriza == "0") {
          this.errors.autoriza = true;
        }
        // Actualizar el estado del formulario
        this.updateFormValid();
      },
      /**
       * Función para actualizar el estado de validación del formulario
       **/
      updateFormValid() {
        // Solo habilitar si todos los campos son válidos Y se ha autorizado el tratamiento de datos
        console.log(
          "updateFormValid called, autoriza value:",
          this.data.autoriza,
          "type:",
          typeof this.data.autoriza
        );
        if (this.data.autoriza == "1") {
          this.formInValid = false;
          console.log(
            "Form validation result:",
            !this.formInValid,
            "formInValid:",
            this.formInValid
          );
        } else {
          this.formInValid = true;
          console.log("Form invalid - no authorization, autoriza:", this.data.autoriza);
        }
      },
      /**
       * Función para verificar si todos los campos son válidos (sin actualizar errores)
       **/
      checkAllFieldsValid() {
        // Verificar campos requeridos básicos
        const basicFields = [
          "first_name",
          "last_name",
          "tipo_doc",
          "numero_doc",
          "email",
          "mobile",
          "prefijoCel",
          "pais",
          "tipo_asistente",
          "dia",
        ];
        for (let field of basicFields) {
          if (!this.data[field] || this.data[field] === "") {
            return false;
          }
        }

        // Verificar email válido
        const emailRegex =
          /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        if (!emailRegex.test(this.data.email)) {
          return false;
        }

        // Verificar mobile válido
        if (this.data.mobile.length < 8) {
          return false;
        }

        // Si es de Colombia, verificar departamento y ciudad
        if (this.data.pais === "COL") {
          if (!this.data.departamento || !this.data.ciudad) {
            return false;
          }
        }

        // Si es aspirante, verificar campos académicos
        if (this.data.tipo_asistente === "Aspirante") {
          if (!this.data.nivelacademico || !this.data.facultad || !this.data.periodo_esperado) {
            console.log("Missing academic fields:", {
              nivelacademico: this.data.nivelacademico,
              facultad: this.data.facultad,
              periodo_esperado: this.data.periodo_esperado,
            });
            return false;
          }
          if (!this.data.programa || this.data.programa === "NOAP") {
            console.log("Program field invalid:", this.data.programa);
            return false;
          }
          // Verificar colegio si no es eclesiástico
          if (this.data.nivelacademico !== "ECLE") {
            if (!this.data.colegio) {
              console.log("Colegio field missing:", this.data.colegio);
              return false;
            }
          }
        }

        return true;
      },
      /**
       * Funcion para limpiar textos
       **/
      limpiarTexto(texto) {
        let textolimpio = texto.replace(/[^a-zA-Záéíóúñ ]/g, "");
        return textolimpio;
      },
      /**
       * Funcion para limpiar numeros
       **/
      limpiarNumeros(numero) {
        let textolimpio = numero.replace(/[^0-9 ]/g, "");
        return textolimpio;
      },
      /**
       * Funcion para limpiar json
       **/
      limpiarJson(texto) {
        return texto
          .replaceAll("|", "")
          .replace(/(\r\n|\n|\r)/gm, "")
          .replace(/['"]+/g, "'")
          .trim();
      },
      /**
       * Funcion para limpiar alfanumericos
       **/
      limpiarAlfanumerico(text) {
        let textolimpio = text.replace(/[^a-zA-Z0-9- ]/g, "");
        return textolimpio;
      },
      /**
       * Funcion para validar que los campos tengan datos
       **/
      validateInputs() {
        let valid = true;
        let keys = Object.keys(this.data);
        keys.forEach((element) => {
          this.errors[element] = false;
          switch (element) {
            case "first_name":
            case "last_name":
            case "tipo_doc":
            case "numero_doc":
            case "pais":
            case "prefijoCel":
            case "tipo_asistente":
            case "dia":
              if (this.data[element] == "" || this.data[element] == null) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "colegio":
              if (
                (this.data[element] == "" || this.data[element] == null) &&
                this.data.nivelacademico != "ECLE" &&
                (this.data.tipo_asistente == "Aspirante" ||
                  this.data.tipo_asistente == "Docente y/o psicoorientador")
              ) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "departamento":
            case "ciudad":
              if (
                (this.data[element] == "" || this.data[element] == null) &&
                this.data.pais == "COL"
              ) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "email":
              const regex =
                /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|.(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
              if (this.data[element] == "" || this.data[element] == null) {
                valid = false;
                this.errors[element] = true;
              } else if (regex.test(this.data[element]) === false) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "mobile":
              if (
                this.data[element] == "" ||
                this.data[element] == null ||
                this.data[element].length < 8
              ) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "nivelacademico":
            case "facultad":
            case "periodo_esperado":
              if (
                (this.data[element] == "" || this.data[element] == null) &&
                this.data.tipo_asistente == "Aspirante"
              ) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "programa":
              if (
                (this.data[element] == "" ||
                  this.data[element] == null ||
                  this.data[element] == "NOAP") &&
                this.data.tipo_asistente == "Aspirante"
              ) {
                valid = false;
                this.errors[element] = true;
              }
              break;
            case "universidad":
              // La universidad se valida a través del campo colegio para GRAD
              // No se requiere validación separada ya que se usa el campo colegio
              break;
            case "autoriza":
              if (this.data[element] != "1") {
                valid = false;
                this.errors[element] = true;
              }
              break;

            default:
              break;
          }
        });
        return valid;
      },
      /**
       * Funcion para enviar el formulario
       **/
      validateForm: function (e) {
        console.log("formInValid:", this.formInValid);
        console.log("autoriza value:", this.data.autoriza);

        const validationResult = this.validateInputs();
        console.log("validateInputs result:", validationResult);
        console.log("Current errors:", this.errors);

        if (!validationResult) {
          console.log("Validation failed - preventing form submit");
          e.preventDefault();
          return false;
        } else {
          console.log("Validation passed - submitting form");
          this.isSubmitting = true;
          this.$refs.form_SF.submit();
        }
      },
      /**
       * Funcion para limpiar en caso que sea invalido
       **/
      deleteInvalid(campo) {
        this.errors[campo] = false;
        // Actualizar el estado del formulario cuando se corrige un campo
        this.updateFormValid();
      },
    },
  });

  const vueApp = app.mount("#app");

  // Event delegation para colegios (backup para Vue events que no funcionan)
  document.addEventListener("click", function (e) {
    // Verificar si el click fue en un elemento de colegio
    const collegeItem = e.target.closest(".list-group-item-action");
    if (collegeItem && collegeItem.closest(".list-group")) {
      const collegeName = collegeItem.textContent.trim();

      // Buscar el colegio en filteredColegios para obtener el ID
      if (vueApp && vueApp.filteredColegios) {
        const selectedCollege = vueApp.filteredColegios.find((c) => c.NAME === collegeName);
        if (selectedCollege) {
          vueApp.selectColegio(selectedCollege.PUJ_EXTERNALORGID__C, selectedCollege.NAME);
        }
      }
    }
  });
</script>

<script
  src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
  integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/popper.js@1.14.7/dist/umd/popper.min.js"
  integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
  crossorigin="anonymous"
></script>
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js"
  integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
  crossorigin="anonymous"
></script>
